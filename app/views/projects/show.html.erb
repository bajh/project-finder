<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
  <div class="project_card col-sm-offset-1 col-md-8">
    <h2 class="project_title"><%= @project.title %></h2> 

    <div class="project_subhead project_status"><%= @project.status %>
      <% if current_user.received_invitation?(@project) %>
        <div class="status_bar">
        <%= button_to "You've been invited to this project. Click to accept Invitation", {controller: "user_projects", action: "accept_invitation", user_id: current_user.id, project_id: @project.id}, method: :post %>
      <% elsif !current_user.projects.include?(@project) %>
        <div class="status_bar">
        <%= button_to "Volunteer for this project", {controller: "user_projects", action: "apply_for_project", user_id: current_user.id, project_id: @project.id}, method: :post %>
        </div>
      <% end %>
      <div class="status_bar">
      <% if @project.admin == current_user %>
        <% if @project.status == "planning" %>
          <%= button_to "Mark as in progress", {controller: "user_projects", action: "in_progress", user_id: current_user.id, project_id: @project.id}, method: :post %>
        <% end %>
        <% if @project.status == "in_progress" %>
          <%= button_to "Mark as completed", {controller: "user_projects", action: "close_project", user_id: current_user.id, project_id: @project.id}, method: :post %>
        <% end %>
      <% end %>
    </div>
    </div>

    <div class="project_description"><p><%= @project.description %></p></div>

    <div class="project_team">
      <h4>Team</h4>
      <ul>
      <div class="team_member">
        <li><%= image_tag avatar_url(@project.admin), class: "gravatar" %><%= @project.admin.name %></li>
      </div>
      <% if @project.current_collaborators %>
        <% @project.current_collaborators.each do |user| %>
            <div class="team_member">
              <li>
                <%= image_tag avatar_url(user), class: "gravatar" %><%= user.name %>
                <% unless user.id == current_user.id || @project.not_completed? %><!-- don't rate yourself -->
                  <ul>
                    <% user.skills.each do |skill| %>
                      <li>
                        <%= skill.name %>
                        <% unless skill.rated?(user, @project) || current_user.is_not_admin_for?(@project) %>
                          <%= button_to "Endorse!", {controller: "user_projects", action: "update", user_id: user.id, project_id: @project.id, skill_id: skill.id}, method: :post %>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                <% end %>
              </li>
            </div>
        <% end %>
      <% end %>
      </ul>
    </div>
    </div>

    <div class="prospective_applicants">
      <% if current_user.is_admin_for?(@project) || @project.current_collaborators.include?(current_user) %>
        <% unless @project.prospective_applicants.empty? %>
        <div class="want_to_join">
          <h4>These people want to join your team</h4>
          <% @project.prospective_applicants.each do |user| %>
            <div class="prospective_collaborator">
              <%= user.name %>
              <div class="skill_set">
                <% user.skills.each do |skill| %>
                  <div class="skill"><%= skill.name %></div>
                <% end %>
              </div>
              <% if current_user.is_admin_for?(@project) %>
                <%= button_to "Approve collaboration", {controller: "user_projects", action: "approve_collaboration", user_id: user.id, project_id: @project.id}, method: :post %>
                <%= button_to "Deny collaboration", {controller: "user_projects", action: "deny_collaboration", user_id: user.id, project_id: @project.id}, method: :post %>
              <% end %>
            </div>
            </div>
          <% end  %>
        </div>
        <% end %>
        <% unless @project.completed? %>
          <div class="suggested_collaborators">
            <% if @project.has_matching_user_skills? %>
            <h4>These people have skills your project is looking for:</h4>
              <% @project.skill_matching_users.each do |user| %>
                <div class="prospective_collaborator">
                  <p><%= user.name %><br/>
                    Relevant skills:<br/>
                    <% user.relevant_skills_for(@project).each do |skill| %>
                      <div class="skill_tab"><%= skill.name %></div>
                    <% end %>
                  </p>
                  <%= button_to "Invite to project", {controller: "user_projects", action: "invite", user_id: user.id, project_id: @project.id}, method: :post %>
                </div>
              <% end %>
            <% else %>
              <h3>No one seems to have the skills you need :/</h3>
            <% end %>
          </div>
        <% end %>
      <% end %>
  </div>
</div>
<% if @project.admin == current_user %>
  <script>
    $(function(){
      $('.status_bar form').hide();
      $('.project_status').on('mouseenter', function(){
        $('.status_bar form').show();
      });
      $('.project_status').on('mouseleave',function(){
          $('.status_bar form').hide();
      })
    })
  </script>
<% end %>

<%= render 'projects/chat_sidebar', project: @project %>

<%= javascript_include_tag "http://localhost:9292/faye/client.js" %>
<script>
  $(function(){
    var faye = new Faye.Client('http://localhost:9292/faye')
    faye.subscribe('/messages/'+<%= @project.id %>,function(data){
      eval(data)
    });

  });
</script>
